- name: Get primordial master IP
  set_fact:
    primordial_ip: "{{ hostvars | dict2items
      | selectattr('value.var_primordial_master', 'defined')
      | selectattr('value.var_primordial_master', 'equalto', true)
      | map(attribute='value.server_ip') | list | first }}"

- name: Wait for primordial master API to be available
  wait_for:
    host: "{{ primordial_ip }}"
    port: 6443
    timeout: 300

- name: Install non primordial Master Node
  shell: |
    curl -sfL https://get.k3s.io | K3S_TOKEN=SECRET sh -s - server \
    --server https://{{ primordial_ip }}:6443 \
    --write-kubeconfig-mode=666 \
    --tls-san={{ server_ip }} \
    --disable servicelb \
    --disable traefik \
    --docker
  become: true
  register: k3s_install
  failed_when: false

- name: Wait for k3s service to be ready
  systemd:
    name: k3s
    state: started
  become: true
  retries: 10
  delay: 10
  register: k3s_service
  until: k3s_service is succeeded
  when: k3s_install.rc != 0

- name: Verify k3s service is running
  systemd:
    name: k3s
    state: started
  become: true

- name: Verify master node joined cluster
  command: k3s kubectl get nodes {{ inventory_hostname }}
  become: true
  retries: 6
  delay: 10
  register: node_status
  until: node_status.rc == 0
  changed_when: false
